package com.doctor.servlet;



import com.dao.MedicalRecordDAO;
import com.Db.DBConnect;
import com.entity.MedicalRecord;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.*;

import java.io.File;
import java.io.IOException;
import java.nio.file.Paths;

@WebServlet("/UploadMedicalRecord")
@MultipartConfig
public class UploadMedicalRecord extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        int userId = Integer.parseInt(request.getParameter("userId"));
        int appointmentId = Integer.parseInt(request.getParameter("appointmentId"));
        Part filePart = request.getPart("reportFile");

        String fileName = Paths.get(filePart.getSubmittedFileName()).getFileName().toString();

        // Save to: WebContent/uploads/
        String uploadPath = getServletContext().getRealPath("/uploads");

        File uploadDir = new File(uploadPath);
        if (!uploadDir.exists()) uploadDir.mkdirs(); // Create folders if needed

        String fullPath = uploadPath + File.separator + fileName;
        filePart.write(fullPath);

        String relativePath = "uploads/" + fileName;
        MedicalRecord record = new MedicalRecord(userId, appointmentId, fileName, relativePath);
        MedicalRecordDAO dao = new MedicalRecordDAO(DBConnect.getconn());

        if (dao.saveMedicalRecord(record)) {
            response.sendRedirect("index.jsp?msg=uploadSuccess");
        } else {
            response.sendRedirect("upload_medical_record.jsp?msg=fail");
        }
    }
}
